# TemPad Skill 协作与优化指南

## 协作关系

### 角色定义

| 角色 | 职责 | 输入 | 输出 |
|------|------|------|------|
| **用户** | 提供设计稿、验证结果、反馈问题 | Figma/MasterGo 选中节点、UI 截图、修正意见 | 问题描述、优化建议 |
| **AI Agent** | 获取数据、分析设计、生成代码 | 截图 + JSON 数据 | 组件代码、资源文件 |
| **Skill 文档** | 规范工作流程、约束行为边界 | 协作经验、错误案例 | 规则、检查清单 |

### 协作流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         设计转代码流程                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   用户                    AI Agent                 Skill 文档    │
│    │                         │                        │         │
│    │  1. 选中设计节点         │                        │         │
│    │  2. 发起转码请求 ───────>│                        │         │
│    │                         │  3. 读取 Skill ────────>│         │
│    │                         │<──────── 获取规则 ──────│         │
│    │                         │                        │         │
│    │                         │  4. 获取截图 + JSON     │         │
│    │                         │  5. 分析设计结构        │         │
│    │                         │  6. 按规则生成代码      │         │
│    │                         │                        │         │
│    │<─── 7. 返回组件代码 ─────│                        │         │
│    │                         │                        │         │
│    │  8. 验证效果             │                        │         │
│    │  9. 反馈问题 ──────────>│                        │         │
│    │                         │ 10. 分析问题原因        │         │
│    │                         │ 11. 更新 Skill ────────>│         │
│    │                         │                        │         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 问题排查工作流

当生成代码出现还原度问题时，需要进行系统性排查。问题可能来自 **Skill 层**（规则/流程）或 **插件层**（数据处理/结构解析）。

### 排查原则

1. **对比优先** - 将截图（视觉真相）与 JSON 数据（结构化描述）进行对比
2. **自主判断** - 根据问题特征选择最高效的排查路径
3. **逐层定位** - 从现象到数据，从数据到代码逻辑

### 问题来源分类

| 层级 | 职责范围 | 典型问题 |
|------|---------|---------|
| **Skill 层** | 规则定义、流程编排、代码生成逻辑 | AI 未按规则使用数据、流程不合理、规则缺失 |
| **插件层** | 设计稿解析、结构转换、样式提取、资源导出 | 数据结构不合理、样式提取不完整、布局算法偏差、资源导出失败 |

### 插件层问题维度

插件层问题通常涉及以下维度，需要综合分析：

| 维度 | 说明 | 示例 |
|------|------|------|
| **结构解析** | 节点树的层级关系、嵌套深度、冗余节点 | 层级过深导致难以理解；无意义的包裹节点 |
| **样式提取** | customStyle 的完整性和准确性 | 缺少边框、颜色值不准、渐变丢失 |
| **布局算法** | layoutMode、间距、对齐方式的转换 | Flex 方向错误、间距计算不准 |
| **资源导出** | 图标、图片的识别和导出 | 图标未识别、导出格式/尺寸问题 |
| **语义描述** | 节点命名、类型标注的准确性 | 类型标注错误、命名无语义 |

### 排查工作流

```
┌─────────────────────────────────────────────────────────────────┐
│                        问题排查工作流                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 收集信息                                                     │
│     ├── 用户反馈的问题现象                                        │
│     ├── 设计稿截图（视觉真相）                                     │
│     └── JSON 数据（结构化描述）                                    │
│                                                                 │
│  2. 对比分析                                                     │
│     └── 截图 vs JSON：找出差异点                                  │
│         ├── 截图有，JSON 没有 → 可能是插件层问题                   │
│         ├── JSON 有，代码没用 → 可能是 Skill 层问题               │
│         └── 两边都有但不一致 → 需要深入分析                        │
│                                                                 │
│  3. 定位根因                                                     │
│     ├── Skill 层：检查规则是否覆盖、流程是否合理                   │
│     └── 插件层：分析具体是哪个维度的问题                           │
│         ├── 结构？样式？布局？资源？语义？                         │
│         └── 定位到具体模块和逻辑                                  │
│                                                                 │
│  4. 制定方案                                                     │
│     ├── Skill 层：更新规则文档                                    │
│     └── 插件层：提交问题报告，说明修复方向                         │
│                                                                 │
│  5. 验证修复                                                     │
│     └── 用相同场景测试，确认问题解决                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 排查要点

- **不要急于下结论** - 问题可能跨层，需要综合分析
- **数据是关键证据** - JSON 数据反映插件的处理结果，是判断的核心依据
- **考虑边界情况** - 特殊的设计稿结构可能暴露插件的边界问题
- **关注可复现性** - 确认问题是个案还是通用问题

---

## 如何优化 Skill

### 优化触发时机

| 问题类型 | 示例 | 优化方向 |
|---------|------|---------|
| **规则缺失** | 生成了 JSON 中不存在的 border | 添加"禁止添加"规则 |
| **流程低效** | 分两次请求截图和 JSON | 改为同时请求 |
| **理解偏差** | 截图和 JSON 职责不清 | 明确职责分工表格 |
| **重复错误** | 多次猜测颜色值 | 添加检查清单 |

### 优化原则

#### 1. 从具体案例抽象通用规则

```
❌ 错误：针对特定组件的规则
"反馈面板的选项标签不要加 border"

✅ 正确：通用规则
"如果 customStyle 中没有某属性，就不要添加该属性"
```

#### 2. 用表格和检查清单替代长文本

```
❌ 错误：大段描述
"在生成样式时，需要检查 JSON 中的 customStyle 字段，
确保每个属性都存在于该字段中，不要自行添加..."

✅ 正确：检查清单
生成样式时检查：
1. ✅ 属性是否存在于 customStyle？
2. ✅ 属性值是否完全复制？
3. ❌ 是否添加了不存在的属性？
```

#### 3. 提供正反对比示例

```javascript
// ❌ 错误做法
border: 1px solid #e5e5e5;  // 自己猜的

// ✅ 正确做法
// JSON: { "customStyle": { "background": "#F2F2F2" } }
// 没有 border，就不加
background: #F2F2F2;
```

#### 4. 明确职责边界

| 数据来源 | 用于 | 不用于 |
|---------|------|-------|
| 截图 | 理解布局结构 | 提取颜色值 |
| JSON | 精确样式属性 | 判断整体布局 |

### 优化流程

```
1. 发现问题
   └── 用户反馈：生成的代码有边框，但设计稿没有

2. 分析原因
   └── AI 根据截图"看起来像有边框"就添加了

3. 定位规则缺失
   └── Skill 没有明确禁止"根据视觉猜测样式"

4. 设计通用规则
   └── "样式属性必须来自 customStyle，不能自行添加"

5. 更新 Skill 文档
   ├── SKILL.md: 添加核心原则
   └── codegen-rules.md: 添加检查清单

6. 验证规则有效性
   └── 用相同场景测试，确认问题不再出现
```

---

## 插件层问题反馈

当排查确定问题来自插件层时，需要向插件开发者提供详细信息。

### 插件代码结构参考

```
packages/extension/
├── src/
│   ├── entrypoints/        # 入口文件
│   ├── components/         # UI 组件
│   ├── composables/        # 组合式函数
│   │   └── codegen/        # 代码生成相关
│   └── utils/              # 工具函数（样式/布局/导出等）
```

### 问题反馈模板

```markdown
## 插件问题报告

### 问题维度
[ ] 结构解析 - 节点树层级/嵌套问题
[ ] 样式提取 - customStyle 不完整或不准确
[ ] 布局算法 - layoutMode/间距/对齐转换问题
[ ] 资源导出 - 图标/图片识别或导出问题
[ ] 语义描述 - 节点类型/命名不准确

### 问题描述
[描述截图与 JSON 数据的差异]

### 对比信息
- 截图显示：[描述视觉效果]
- JSON 数据：[相关字段的实际值]
- 期望数据：[应该是什么]

### 设计稿信息
- 设计工具：Figma / MasterGo
- 节点名称/ID：XXX

### 复现步骤
1. 选中 XXX 节点
2. 调用 get_design API
3. 观察到 XXX 问题
```

---

## Skill 文档结构

```
.claude/skills/tempad-skill/
├── SKILL.md                 # 主文档：工作流程、核心原则
├── CONTRIBUTING.md          # 本文档：协作关系、问题排查、优化指南
├── references/
│   ├── codegen-rules.md     # 代码生成规范
│   ├── design-schema.md     # JSON 字段说明
│   └── api.md               # API 接口文档
└── scripts/
    └── download-assets.cjs  # 资源下载脚本
```

### 各文档职责

| 文档 | 职责 | 更新频率 |
|------|------|---------|
| `SKILL.md` | 定义工作流程、核心原则 | 流程变更时 |
| `CONTRIBUTING.md` | 说明协作关系、问题排查、优化方法 | 协作模式调整时 |
| `codegen-rules.md` | 规范代码生成细节 | 发现新的生成问题时 |
| `design-schema.md` | 解释 JSON 字段含义 | API 返回结构变更时 |
| `api.md` | 记录 API 接口详情 | 接口变更时 |

---

## 版本记录

| 版本 | 日期 | 改进内容 |
|------|------|---------|
| v1.0 | - | 基础工作流程 |
| v1.1 | - | 明确截图 vs JSON 职责分工；添加样式检查清单 |
| v1.2 | - | 重构问题排查工作流；细化插件层问题维度（结构/样式/布局/资源/语义） |
| v1.3 | - | 明确多模态能力判断；强制截图先行；记录根节点 id 缺失问题 |
| v1.4 | - | API 返回 `rootNodeId` 字段，明确提供根节点 ID 用于截图下载 |
